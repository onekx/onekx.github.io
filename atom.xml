<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kx&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://onekx.github.io/"/>
  <updated>2020-04-03T10:57:55.590Z</updated>
  <id>http://onekx.github.io/</id>
  
  <author>
    <name>Kx&#39;s Blog</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>对 Promise 的理解</title>
    <link href="http://onekx.github.io/post/about_promise/"/>
    <id>http://onekx.github.io/post/about_promise/</id>
    <published>2020-04-03T10:47:31.000Z</published>
    <updated>2020-04-03T10:57:55.590Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><a href="../../../images/Promise.png" data-caption data-fancybox="images"><img src="../../../images/Promise.png" alt></a><hr><p><strong>以下是自己对Promise的简单理解</strong></p><h3 id="Promise的作用：">Promise的作用：<a class="post-anchor" href="#Promise的作用："></a></h3><p>js中使用回调函数进行事件处理，如果嵌套多层回调函数，将会陷入 回调地狱，使代码难以理解以及维护，例如：</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript">method1(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{<br>    <span class="hljs-keyword">if</span> (err) {<br>        <span class="hljs-keyword">throw</span> err;<br>    } <br>    method2(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{<br>        <span class="hljs-keyword">if</span> (err) {<br>            <span class="hljs-keyword">throw</span> err;<br>        } <br>        method3(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{<br>            <span class="hljs-keyword">if</span> (err) {<br>                <span class="hljs-keyword">throw</span> err;<br>            } <br>            method4(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{<br>                <span class="hljs-keyword">if</span> (err) {<br>                    <span class="hljs-keyword">throw</span> err;<br>                } <br>                method5(result);<br>            });<br>        });<br>    });<br>});<br></code></pre></td></tr></tbody></table></figure><p><strong>Promise就是解决以上这种问题的异步编程方案。</strong></p><hr><h3 id="Promise的构造：">Promise的构造：<a class="post-anchor" href="#Promise的构造："></a></h3><p>在控制台中将Promise打印出来:</p><a href="../../../images/Promise的结构.png" data-caption data-fancybox="images"><img src="../../../images/Promise的结构.png" alt></a><p>可以看到Promise对象是一个构造函数，且本身就包含了 resolve, reject, all, race等方法，原型上有 then, catch, finally等方法，所以 Promise new 出来的对象一定包含以上方法。</p><hr><h3 id="Promise的三种状态：">Promise的三种状态：<a class="post-anchor" href="#Promise的三种状态："></a></h3><p><strong>Pending（进行中）</strong>，<strong>Fulfilled（已完成）</strong>，<strong>Rejected（已拒绝）</strong></p><p>当Promise被声明时，即处于 <strong>“Pending”</strong> 状态，接着 <strong>只有两种状态变更</strong> 的可能 <strong>“Pending => Fufilled”</strong> （Fufilled对应的就是resolve方法）和 <strong>“Pending => Rejected”</strong>，状态的变更是单向不可逆的。</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {});<br><span class="hljs-comment">// Pending状态</span><br><span class="hljs-keyword">var</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> resolve());<br><span class="hljs-comment">// Fulfilled状态</span><br><span class="hljs-keyword">var</span> promise3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> reject());<br><span class="hljs-comment">// Rejected状态</span><br></code></pre></td></tr></tbody></table></figure><hr><h3 id="then-、-catch-和-finally-的用法：">then 、 catch 和 finally  的用法：<a class="post-anchor" href="#then-、-catch-和-finally-的用法："></a></h3><p><strong>then的用法：</strong></p><p>then可以理解为成功时调用的方法。then有两个参数，第一个参数是 resolved 状态的回调函数，第二个参数 <strong>(可选)</strong> 是 rejected 状态的回调函数。<strong>建议then中只接受第一个参数，第二个参数放到 catch 中解决</strong></p><p><strong>catch的用法：</strong></p><p>catch是失败时调用的方法。catch只接受一个参数，即当发生错误时的回调函数。<strong>.catch()</strong>  等同于 <strong>.then(null, rejection)</strong> 或  <strong>.then(undefined, rejection)</strong></p><p><strong>finally的用法：</strong></p><p>finally方法用于指定不管 Promise 对象最后状态如何，在执行完then或catch指定的回调函数以后，都会执行finally方法指定的回调函数。</p><p>例：</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> flag = <span class="hljs-literal">true</span>;<br><br><span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {<br>    <span class="hljs-keyword">if</span>(flag) {<br>        resolve(<span class="hljs-literal">true</span>);<br>    } <span class="hljs-keyword">else</span> {<br>        reject(<span class="hljs-literal">false</span>);<br>    }<br>});<br><br>promise.then(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'成功'</span>);<br>}).catch(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'失败'</span>);<br>}).finally(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'结束'</span>);<br>});<br><br><span class="hljs-comment">// 当 flag = true 时打印出 成功 结束。</span><br><span class="hljs-comment">// 当 flag = false 时打印出 失败 结束。</span><br></code></pre></td></tr></tbody></table></figure><hr><h3 id="all-和-race-方法：">all 和 race 方法：<a class="post-anchor" href="#all-和-race-方法："></a></h3><p><strong>all的用法：</strong></p><p>.all()接受一个 Promise 的示例数组，只有当所有全部 Promise 执行 resolve 或者有一个 reject 后才执行下一步。</p><p>1.当所有 Promise 都为 resolve 时：</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> {<br>    resolve(<span class="hljs-number">1</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> {<br>    resolve(<span class="hljs-number">2</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> {<br>    resolve(<span class="hljs-number">3</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise4 = <span class="hljs-built_in">Promise</span>.all([promise1,promise2,promise3]);<br>promise4.then(<span class="hljs-function"><span class="hljs-params">value</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(value);<br>})<br><br><span class="hljs-comment">// [1,2,3]</span><br><span class="hljs-comment">// 在有不同延时的定时器情况下，输出的顺序仍然会按照原参数的顺序输出，还是[1,2,3]</span><br></code></pre></td></tr></tbody></table></figure><p>2.若某个 Promise 被拒绝了，那么会立即结束，不会等待其他 Promise 的结束：</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        reject(<span class="hljs-number">1</span>);<br>    },<span class="hljs-number">1000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        resolve(<span class="hljs-number">2</span>);<br>    },<span class="hljs-number">2000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        resolve(<span class="hljs-number">3</span>);<br>    },<span class="hljs-number">3000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise4 = <span class="hljs-built_in">Promise</span>.all([promise1,promise2,promise3]);<br>promise4.then(<span class="hljs-function"><span class="hljs-params">value</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(value);<br>}).catch(<span class="hljs-function"><span class="hljs-params">value</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(value);<br>})<br>    <br><span class="hljs-comment">// 1</span><br><span class="hljs-comment">// 因为 promise1 为 reject，所以 .all() 会理解结束，不会等待 promise2 和 promise3 的结束</span><br></code></pre></td></tr></tbody></table></figure><p><strong>race 的用法：</strong></p><p>race 与 all 一样可以接受一个由 Promise 组成的数组作为参数，但是 race 不会等待所有 Promise 执行完成，只要数组中有一个 Promise 状态发生改变，调用 race 方法的 Promise 就会立即改变，状态由最先结束的 Promise 决定。</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        reject(<span class="hljs-number">1</span>);<br>    },<span class="hljs-number">4000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        resolve(<span class="hljs-number">2</span>);<br>    },<span class="hljs-number">2000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =></span> {<br>    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =></span> {<br>        resolve(<span class="hljs-number">3</span>);<br>    },<span class="hljs-number">3000</span>);<br>});<br><br><span class="hljs-keyword">let</span> promise4 = <span class="hljs-built_in">Promise</span>.race([promise1,promise2,promise3]);<br>promise4.then(<span class="hljs-function"><span class="hljs-params">value</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(value);<br>}).catch(<span class="hljs-function"><span class="hljs-params">value</span> =></span> {<br>    <span class="hljs-built_in">console</span>.log(value);<br>})<br><br><span class="hljs-comment">// 2</span><br><span class="hljs-comment">// promise2 延时两秒最先完成，然后立即结束，状态为resolve</span><br></code></pre></td></tr></tbody></table></figure></body></html>]]></content>
    
    <summary type="html">
    
      
      
        &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;a href=&quot;../../../images/Promise.png&quot; data-caption data-fancybox=&quot;images&quot;&gt;&lt;img src=&quot;../../../images/Promise.png&quot; al
      
    
    </summary>
    
    
    
      <category term="ES6" scheme="http://onekx.github.io/tags/ES6/"/>
    
      <category term="JavaScript" scheme="http://onekx.github.io/tags/JavaScript/"/>
    
  </entry>
  
</feed>
